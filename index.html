<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>实控人GMV展示系统</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* ============================
   基础样式
   ============================ */
:root {
  --primary-color: #c3b092;
  --primary-dark: #b5a17e;
  --primary-light: #e6dfd3;
  --primary-bg: #f9f7f4;
  --secondary-bg: #f0ede8;
  --text-primary: #5a4a3e;
  --text-secondary: #8a7a6a;
  --text-light: #a89a8c;
  --border-color: #e2d9cf;
  --border-light: #f0eae2;
  --success-color: #4caf50;
  --warning-color: #ff9800;
  --danger-color: #f44336;
  --white: #ffffff;
  --shadow-light: 0 2px 8px rgba(181, 161, 126, 0.1);
  --shadow-medium: 0 4px 12px rgba(181, 161, 126, 0.15);
  --shadow-heavy: 0 6px 18px rgba(181, 161, 126, 0.2);
  --border-radius: 12px;
  --border-radius-sm: 8px;
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
}

body {
  font-family: "微软雅黑", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: linear-gradient(to bottom, var(--primary-bg), var(--secondary-bg));
  color: var(--text-primary);
  line-height: 1.6;
  font-size: 14px;
}

/* ============================
   布局组件
   ============================ */
.container {
  max-width: 1400px;
  margin: 0 auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 20px;
  background: rgba(195, 176, 146, 0.1);
  border-radius: var(--border-radius);
  border-left: 4px solid var(--primary-color);
  box-shadow: var(--shadow-light);
}

.header h1 {
  margin: 0;
  font-size: 24px;
  color: var(--primary-dark);
  font-weight: 600;
}

.header-info {
  color: var(--text-secondary);
  font-size: 13px;
}

.card {
  background: var(--white);
  border-radius: var(--border-radius);
  padding: 20px;
  box-shadow: var(--shadow-light);
  margin-bottom: 20px;
  border: 1px solid var(--border-light);
  transition: var(--transition);
}

.card:hover {
  box-shadow: var(--shadow-medium);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-light);
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--primary-dark);
  margin: 0;
}

/* ============================
   表单组件
   ============================ */
.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: var(--text-primary);
}

.form-control {
  width: 100%;
  padding: 10px 12px;
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
  font-size: 14px;
  background: var(--white);
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(195, 176, 146, 0.2);
}

.form-control-sm {
  padding: 8px 10px;
  font-size: 13px;
}

/* ============================
   按钮组件
   ============================ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  border-radius: var(--border-radius-sm);
  border: none;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  line-height: 1;
}

.btn:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(195, 176, 146, 0.3);
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: var(--white);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.btn-secondary {
  background: var(--secondary-bg);
  color: var(--primary-dark);
  border: 1px solid var(--primary-light);
}

.btn-secondary:hover {
  background: var(--primary-light);
}

.btn-sm {
  padding: 8px 12px;
  font-size: 13px;
}

.btn-icon {
  padding: 8px;
  border-radius: 50%;
  width: 36px;
  height: 36px;
}

/* ============================
   控制面板
   ============================ */
.controls-panel {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-top: 16px;
  padding: 16px;
  background: rgba(195, 176, 146, 0.05);
  border-radius: var(--border-radius);
}

.control-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-label {
  font-weight: 500;
  color: var(--text-primary);
  white-space: nowrap;
}

/* ============================
   表格样式
   ============================ */
.table-container {
  overflow: auto;
  border-radius: var(--border-radius);
  border: 1px solid var(--border-light);
  margin-top: 16px;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.table th {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: var(--white);
  font-weight: 600;
  padding: 12px 10px;
  text-align: center;
  position: sticky;
  top: 0;
}

.table td {
  padding: 10px 8px;
  border-bottom: 1px solid var(--border-light);
  text-align: center;
}

.table tbody tr:nth-child(even) {
  background: rgba(249, 247, 244, 0.5);
}

.table tbody tr:hover {
  background: rgba(195, 176, 146, 0.08);
}

.table tbody tr.warning {
  background: rgba(255, 152, 0, 0.1);
}

/* ============================
   指示器卡片
   ============================ */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.indicator-card {
  background: var(--white);
  border-radius: var(--border-radius);
  padding: 20px;
  box-shadow: var(--shadow-light);
  transition: var(--transition);
  border-top: 4px solid var(--primary-color);
}

.indicator-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-medium);
}

.indicator-card h3 {
  font-size: 16px;
  color: var(--primary-dark);
  margin: 0 0 16px 0;
  font-weight: 600;
  text-align: center;
}

.indicator-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.indicator-item {
  text-align: center;
  padding: 8px;
  border-radius: var(--border-radius-sm);
  background: rgba(249, 247, 244, 0.5);
}

.indicator-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.indicator-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary-dark);
}

/* ============================
   图表区域
   ============================ */
.chart-container {
  background: var(--white);
  border-radius: var(--border-radius);
  padding: 20px;
  box-shadow: var(--shadow-light);
  margin-bottom: 20px;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.chart-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--primary-dark);
  margin: 0;
}

.chart-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
}

/* ============================
   模态框
   ============================ */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
}

.modal-content {
  background: var(--white);
  margin: 5% auto;
  padding: 24px;
  border-radius: var(--border-radius);
  width: 90%;
  max-width: 1000px;
  max-height: 80%;
  overflow: auto;
  box-shadow: var(--shadow-heavy);
  border: 1px solid var(--primary-color);
  position: relative;
}

.modal-close {
  position: absolute;
  top: 16px;
  right: 16px;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: var(--transition);
}

.modal-close:hover {
  background: rgba(0,0,0,0.05);
  color: var(--text-primary);
}

.tab-nav {
  display: flex;
  gap: 4px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border-light);
}

.tab-btn {
  padding: 10px 20px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-secondary);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.tab-btn.active {
  color: var(--primary-dark);
  border-bottom-color: var(--primary-color);
}

.tab-btn:hover:not(.active) {
  color: var(--text-primary);
}

/* ============================
   工具类
   ============================ */
.text-primary { color: var(--primary-color); }
.text-secondary { color: var(--text-secondary); }
.text-light { color: var(--text-light); }
.text-success { color: var(--success-color); }
.text-warning { color: var(--warning-color); }
.text-danger { color: var(--danger-color); }

.bg-primary { background-color: var(--primary-color); }
.bg-secondary { background-color: var(--secondary-bg); }

.badge {
  display: inline-block;
  padding: 4px 8px;
  background: var(--primary-color);
  border-radius: 12px;
  color: var(--white);
  font-size: 11px;
  font-weight: 500;
}

.clickable {
  color: var(--primary-dark);
  cursor: pointer;
  text-decoration: underline;
  transition: var(--transition);
}

.clickable:hover {
  color: var(--primary-color);
}

.flex {
  display: flex;
}

.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.flex-center {
  display: flex;
  align-items: center;
  gap: 8px;
}

.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 16px; }
.mb-3 { margin-bottom: 24px; }

.mt-0 { margin-top: 0; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }

.text-center { text-align: center; }
.text-right { text-align: right; }

.hidden { display: none; }

/* ============================
   响应式设计
   ============================ */
@media (max-width: 1200px) {
  .dashboard-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  body {
    padding: 12px;
  }
  
  .header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .controls-panel {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .control-group {
    width: 100%;
    justify-content: space-between;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .indicator-grid {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    width: 95%;
    padding: 16px;
  }
  
  .tab-nav {
    overflow-x: auto;
  }
}

@media (max-width: 480px) {
  .table-container {
    font-size: 12px;
  }
  
  .table th, .table td {
    padding: 8px 6px;
  }
  
  .btn {
    padding: 8px 12px;
    font-size: 13px;
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>实控人GMV展示系统</h1>
    <div class="header-info">上传Excel → 选择年/季/月/日 → 大盘概览 → 下钻分析 → 档案查看 | 当前日期: 2025年9月26日</div>
  </div>

  <div class="card">
    <div class="flex-center mb-2">
      <label class="form-label mb-0"><strong>上传 Excel：</strong></label>
      <input type="file" id="excelFile" accept=".xlsx,.xls" class="form-control form-control-sm" style="width: auto;">
      <span class="text-light">（支持24/25年sheet：25-9月等）</span>
    </div>

    <div class="controls-panel">
      <div class="control-group">
        <label class="control-label">年份：</label>
        <select id="yearSelect" class="form-control form-control-sm">
          <option value="25">2025</option>
          <option value="24">2024</option>
        </select>
      </div>

      <div class="control-group">
        <label class="control-label">季度：</label>
        <select id="quarterSelect" class="form-control form-control-sm">
          <option value="">全年</option>
          <option value="1">Q1 (1-3月)</option>
          <option value="2">Q2 (4-6月)</option>
          <option value="3">Q3 (7-9月)</option>
          <option value="4">Q4 (10-12月)</option>
        </select>
      </div>

      <div class="control-group">
        <label class="control-label">月份：</label>
        <select id="monthSelect" class="form-control form-control-sm"></select>
      </div>

      <div class="control-group">
        <label class="control-label">日期：</label>
        <button id="prevDate" class="btn btn-secondary btn-sm btn-icon">&lt;</button>
        <select id="dateSelect" class="form-control form-control-sm"></select>
        <button id="nextDate" class="btn btn-secondary btn-sm btn-icon">&gt;</button>
      </div>

      <div class="control-group">
        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="搜索实控人/经销商/渠道/店铺...">
      </div>

      <div class="control-group">
        <label class="control-label">图表类型：</label>
        <select id="chartType" class="form-control form-control-sm">
          <option value="line">趋势线</option>
          <option value="bar">柱状图</option>
          <option value="pie">饼图</option>
        </select>
      </div>

      <div class="control-group">
        <label class="control-label">维度：</label>
        <select id="chartDimension" class="form-control form-control-sm">
          <option value="person">实控人</option>
          <option value="dealer">经销商</option>
          <option value="channel">渠道</option>
          <option value="store">店铺</option>
        </select>
      </div>

      <div class="control-group">
        <label class="control-label">对象：</label>
        <select id="chartTarget" class="form-control form-control-sm"></select>
      </div>

      <div class="control-group">
        <button id="renderChartBtn" class="btn btn-primary btn-sm">渲染图表</button>
        <button id="compareBtn" class="btn btn-secondary btn-sm hidden">比较模式</button>
      </div>

      <div class="control-group" style="margin-left: auto;">
        <button id="exportBtn" class="btn btn-secondary btn-sm">导出 (Excel)</button>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="indicator-card">
      <h3>年指标</h3>
      <div class="indicator-grid">
        <div class="indicator-item">
          <div class="indicator-label">年目标</div>
          <div class="indicator-value" id="year-target">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">年GMV</div>
          <div class="indicator-value" id="year-gmv">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">目标达成率</div>
          <div class="indicator-value" id="year-achieve-rate">0%</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">同比</div>
          <div class="indicator-value" id="year-yoy">0%</div>
        </div>
      </div>
    </div>

    <div class="indicator-card">
      <h3>季指标</h3>
      <div class="indicator-grid">
        <div class="indicator-item">
          <div class="indicator-label">季目标</div>
          <div class="indicator-value" id="quarter-target">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">季GMV</div>
          <div class="indicator-value" id="quarter-gmv">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">目标达成率</div>
          <div class="indicator-value" id="quarter-achieve-rate">0%</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">同比</div>
          <div class="indicator-value" id="quarter-yoy">0%</div>
        </div>
      </div>
    </div>

    <div class="indicator-card">
      <h3>月指标</h3>
      <div class="indicator-grid">
        <div class="indicator-item">
          <div class="indicator-label">月目标</div>
          <div class="indicator-value" id="month-target">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">月GMV</div>
          <div class="indicator-value" id="month-gmv">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">目标达成率</div>
          <div class="indicator-value" id="month-achieve-rate">0%</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">同比</div>
          <div class="indicator-value" id="month-yoy">0%</div>
        </div>
      </div>
    </div>

    <div class="indicator-card">
      <h3>日指标</h3>
      <div class="indicator-grid">
        <div class="indicator-item">
          <div class="indicator-label">日目标</div>
          <div class="indicator-value" id="day-target">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">日GMV</div>
          <div class="indicator-value" id="day-gmv">0万</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">目标达成率</div>
          <div class="indicator-value" id="day-achieve-rate">0%</div>
        </div>
        <div class="indicator-item">
          <div class="indicator-label">同比</div>
          <div class="indicator-value" id="day-yoy">0%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">数据概览</h2>
      <div class="flex-center">
        <span class="text-light" id="dataSummary">请上传 Excel 并选择年/季/月</span>
      </div>
    </div>
    <div id="content">
      <div class="text-center text-light">请上传 Excel 并选择年/季/月。</div>
    </div>
  </div>

  <div class="flex" style="gap: 20px;">
    <div class="chart-container" style="flex: 2; display: none;" id="chartArea">
      <div class="chart-header">
        <div>
          <h3 class="chart-title" id="chartTitle">趋势图</h3>
          <div class="chart-subtitle" id="chartSubtitle"></div>
        </div>
        <div class="text-light">单位：万 (1位小数)</div>
      </div>
      <canvas id="gmvChart" height="280"></canvas>
    </div>

    <div class="card" style="flex: 1; display: none;" id="quickStats">
      <div class="card-header">
        <h3 class="card-title mb-0">Top 3 店铺</h3>
      </div>
      <ul id="statsList" style="list-style: none; padding: 0; margin: 0;">
        <!-- 动态填充 -->
      </ul>
    </div>
  </div>
</div>

<!-- 模态框：档案 -->
<div id="profileModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div class="tab-nav" id="profileTabs">
      <!-- 动态tab -->
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* ============================
   全局变量
   ============================ */
let sheetData = {}; // { "25-9月": array of rows, ... }
let currentYear = 25;
let currentQuarter = '';
let currentMonth = 9; // 当前9月
let currentSheet = [];
let dailyColumns = [];
let selectedDate = '';
let currentPage = 'dashboard';
let currentFilters = { person: '', dealer: '', channel: '', store: '' };
let gmvChart = null;
let compareMode = false;
let searchTerm = '';

const today = new Date('2025-09-26'); // 固定当前日期

// 经销商排序 (完整列表)
const dealerOrder = [
  "杭州黑标优选品牌管理有限公司", "杭州集智电子商务有限公司", "杭州蓝传品牌管理有限公司",
  "杭州蓝聚电子商务有限公司", "杭州蓝宥电子商务有限公司", "杭州蓝智电子商务有限公司",
  "杭州千贝科技有限公司", "杭州千回科技有限公司", "杭州千岚电子商务有限公司",
  "杭州千岚科技有限公司", "杭州千炼科技有限公司", "杭州千蓦科技有限公司",
  "杭州千宥科技有限公司", "杭州千愿品牌管理有限公司", "杭州浅燃电子商务有限公司",
  "杭州浅蕊电子商务有限公司", "杭州浅昇电子商务有限公司", "杭州浅饰电子商务有限公司",
  "杭州浅惜电子商务有限公司", "杭州浅莹电子商务有限公司", "杭州特海微电子商务有限公司",
  "杭州泽蓦文化创意有限公司", "杭州泽饰文化创意有限公司", "杭州泽娱文化创意有限公司",
  "汕头市凯旭服饰有限公司", "苏州集淘供应链管理有限公司", "苏州量擎云娱品牌管理有限公司",
  "苏州翔之艺文化传媒有限公司", "黄友君", "陈佳", "周磊"
];

// 渠道映射函数
function mapChannel(channel) {
  if (!channel) return '其他渠道';
  const lower = channel.toLowerCase();
  if (['天猫', '淘宝', '淘工厂', '天猫超市', '1688'].some(c => channel.includes(c))) return '阿里渠道';
  if (['抖音小店', '抖音（商城）'].some(c => channel.includes(c))) return '抖音渠道';
  if (['京东自营', '京东pop'].some(c => channel.includes(c))) return '京东渠道';
  if (channel.includes('快手小店')) return '快手渠道';
  if (channel.includes('拼多多')) return '拼多多渠道';
  if (channel.includes('唯品会')) return '唯品会渠道';
  if (channel.includes('小红书')) return '小红书渠道';
  if (channel.includes('得物（毒）')) return '得物渠道';
  if (channel.includes('视频号') || channel.includes('微信小店（视频号）')) return '视频号渠道';
  if (['爱库存', '微信公众号', '好衣库', '杉杉奥莱小程序', '微信小程序', '百度', '快团团', '喵街', '有赞', '壹品仓', '美团优选', '其他'].some(c => channel.includes(c))) return '其他渠道';
  return '其他渠道';
}

// 实控人档案 (完整，从台账提取)
const personProfiles = {
  "张明轩": {
    code: "SK016544",
    basic: {
      "授权方式": "普通授权",
      "授权品牌": "百家好事业群",
      "销售对接人": "章婷",
      "事业群负责人": "黄倩",
      "实控人身份证": "372330199003155114",
      "实控人联系地址": "杭州市滨江区阿里中心.杭州滨江2号楼",
      "实控人联系方式": "15382344723",
      "实控人联系邮箱": "liangqing@lqyymedia.com",
      "银行开户行信息": "工商银行山东滨州邹平支行",
      "银行卡信息": "6222031202011637229",
      "身份证复印件": "张明轩身份证复印件.png",
      "银行卡复印件": "张明轩银行卡复印件.png"
    },
    team: {
      "总人数": "170人，其中百家好123人，占比72%",
      "总业务": "女装自有白牌1个、合作服装授权品牌只有百家好",
      "25年总业绩": "13亿，百家好8亿，占比61%",
      "25年实际完成": "",
      "团队组织架构": [
        "总管：刘清凯(为实控人张明轩合伙人，其占股49%)",
        "供应链负责人：张星（73人），联系方式：18662756388",
        "直播负责人：赵锦泽（25人），联系方式：13868196058",
        "货架负责人：唐涛（15人），联系方式：19816898899",
        "达人负责人：小灰（2人），联系方式：13585090956"
      ]
    },
    dealers: [
    {序号:1, 类型:"公司", "统一信用社代码":"91330100MA2J2FE179", "经销商主体":"杭州黑标优选品牌管理有限公司", "授权品牌":"百家好/BASIC HOUSE", "许可方式":"普通许可", "签约类型":"续签", "品类":"女装/女士精品", "授权开始":"2025-01-01", "授权截止":"2025-12-31"},
    {序号:28, 类型:"公司", "统一信用社代码":"91330108MAE72KG652", "经销商主体":"杭州蓝智电子商务有限公司", "授权品牌":"MIND BRIDGE", "许可方式":"普通许可", "签约类型":"新签", "品类":"女装/女士精品", "授权开始":"2025-06-01", "授权截止":"2025-12-31"}
    ],
    suppliers: [
      {序号:1, 类型:"前店后厂", "统一信用社代码":"91330108MACCW89K78", "供应商主体":"杭州千回科技有限公司", "授权品牌":"百家好/BASIC HOUSE", "生产方式":"组货生产", "保底申领金额（元）":"20500000", "品类":"女装/女士精品，男装，女士内衣/男士内衣/家居服", "授权开始":"2025/4/1", "授权截止":"2025/12/31", "组货工厂":"--汕头市向葵内衣有限公司 --海宁新雪服饰科技有限公司,--女士内衣/男士内衣/家居服 --男装女装/女士精品"},
      {序号:2, 类型:"前店后厂", "统一信用社代码":"91330108MA2KGFYJ9E", "供应商主体":"杭州千岚科技有限公司", "授权品牌":"百家好/BASIC HOUSE", "生产方式":"组货生产", "保底申领金额（元）":"2500000", "品类":"女装/女士精品，男装，女士内衣/男士内衣/家居服", "授权开始":"2025/1/1", "授权截止":"2025/12/31"},
      {序号:3, 类型:"前店后厂", "统一信用社代码":"91330108MACCW89K78", "供应商主体":"杭州千回科技有限公司", "授权品牌":"MIND BRIDGE", "生产方式":"组货生产", "保底申领金额（元）":"30000", "品类":"女装/女士精品", "授权开始":"2025/6/1", "授权截止":"2025/12/31"}
    ],
    stores: [
    {序号:1, "类目筛选":"女装", "统一信用社代码":"91330113MADFX1GK2T", "经销商主体":"杭州福岚电子商务有限公司", "授权品牌":"百家好/BASIC HOUSE", "销售渠道-大类":"抖音渠道", "销售渠道-小类":"抖音小店", "店铺类型":"专卖店", "店铺名称":"百家好Basic House福岚专卖店", "品类":"女装/女士精品", "授权开始":"2025-01-01", "授权截止":"2025-12-31", "主力供应商（确认）":"杭州千回科技有限公司", "本次实收保证金（元）":"0", "25年保证金性质":"共用", "25年授权费（元）":"0", "实控人第几家店铺":"39"},
    {序号:58, "类目筛选":"MB-女装", "统一信用社代码":"91330108MAE72KG652", "经销商主体":"杭州蓝智电子商务有限公司", "授权品牌":"MIND BRIDGE", "销售渠道-大类":"阿里渠道", "销售渠道-小类":"天猫", "店铺类型":"旗舰店", "店铺名称":"BASICHOUSE百家好集团旗舰店", "品类":"女装/女士精品", "授权开始":"2025/6/1", "授权截止":"2025-12-31", "主力供应商（确认）":"杭州千回科技有限公司", "本次实收保证金（元）":"100000", "25年保证金性质":"现缴", "25年授权费（元）":"116667", "实控人第几家店铺":"1"}
    ]
  }
};

/* ============================
   工具函数
   ============================ */
function formatWan(num) {
  if (num === null || num === undefined || isNaN(Number(num))) return "-";
  const n = Number(num);
  if (n === 0) return "0万";
  const wan = Math.round((n / 10000) * 10) / 10;
  return wan.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + "万";
}

function toNum(v) { return Number(v || 0); }

function safeDiv(a, b) { return b ? (a / b * 100).toFixed(1) + '%' : '-'; }

function parseSheetKey(key) {
  const match = key.match(/(\d{2})-(\d+)月/);
  return match ? { year: parseInt(match[1]), month: parseInt(match[2]) } : null;
}

function getSheetName(year, month) {
  return `${year}-${month}月`;
}

/* ============================
   事件绑定
   ============================ */
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('excelFile').addEventListener('change', handleFile);
  document.getElementById('yearSelect').addEventListener('change', e => { currentYear = parseInt(e.target.value); updateMonthOptions(); loadSheet(); });
  document.getElementById('quarterSelect').addEventListener('change', e => { currentQuarter = e.target.value; updateMonthOptions(); loadSheet(); });
  document.getElementById('monthSelect').addEventListener('change', e => { currentMonth = parseInt(e.target.value); loadSheet(); });
  document.getElementById('dateSelect').addEventListener('change', () => { selectedDate = document.getElementById('dateSelect').value; updateView(); });
  document.getElementById('prevDate').addEventListener('click', () => changeDate(-1));
  document.getElementById('nextDate').addEventListener('click', () => changeDate(1));
  document.getElementById('searchInput').addEventListener('input', e => { searchTerm = e.target.value.toLowerCase().trim(); updateView(); });
  document.getElementById('chartDimension').addEventListener('change', () => { buildChartTargetOptions(currentSheet); });
  document.getElementById('chartType').addEventListener('change', renderChartFromControls);
  document.getElementById('renderChartBtn').addEventListener('click', renderChartFromControls);
  document.getElementById('compareBtn').addEventListener('click', toggleCompareMode);
  document.getElementById('exportBtn').addEventListener('click', exportData);

  document.getElementById('yearSelect').value = currentYear;
  updateMonthOptions();
  loadSheet();
});

/* ============================
   Excel 读取 & 加载 (优化年月解析，添加渠道映射)
   ============================ */
async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  console.log('开始读取文件:', file.name);
  
  try {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });

    console.log('Excel文件读取成功，Sheet列表:', workbook.SheetNames);
    
    sheetData = {};
    let foundSheets = 0;
    
    workbook.SheetNames.forEach(name => {
      console.log('处理Sheet:', name);
      const parsed = parseSheetKey(name.trim());
      if (parsed) {
        console.log(`找到有效Sheet: ${name}, 年份: ${parsed.year}, 月份: ${parsed.month}`);
        const sheetDataArray = XLSX.utils.sheet_to_json(workbook.Sheets[name], { defval: '' });
        sheetData[name] = sheetDataArray;
        foundSheets++;
        console.log(`Sheet ${name} 数据行数:`, sheetDataArray.length);
        if (sheetDataArray.length > 0) {
          console.log('第一行数据:', sheetDataArray[0]);
          console.log('所有列名:', Object.keys(sheetDataArray[0]));
        }
      } else {
        console.log(`Sheet ${name} 不符合命名格式 (应为: 25-9月)`);
      }
    });

    console.log(`总共找到 ${foundSheets} 个有效Sheet`);

    if (Object.keys(sheetData).length === 0) {
      alert('未找到有效sheet (格式应为: 25-9月)\n请检查Excel文件中的Sheet命名');
      return;
    }

    // 填充年份
    const yearSelect = document.getElementById('yearSelect');
    yearSelect.innerHTML = '';
    const years = [...new Set(Object.keys(sheetData).map(key => parseSheetKey(key).year))].sort((a, b) => b - a);
    console.log('可用的年份:', years);
    years.forEach(y => yearSelect.appendChild(new Option(`20${y}`, y)));
    currentYear = years[0] || 25;

    updateMonthOptions();
    loadSheet();
    
  } catch (error) {
    console.error('读取Excel文件时出错:', error);
    alert('读取Excel文件失败，请检查文件格式是否正确');
  }
}

// 增强的Sheet名称解析函数
function parseSheetKey(key) {
  console.log('解析Sheet名称:', key);
  
  // 尝试多种可能的格式
  let match = key.match(/(\d{2})-(\d+)月/); // 25-9月
  if (match) {
    return { year: parseInt(match[1]), month: parseInt(match[2]) };
  }
  
  match = key.match(/(\d{4})年(\d+)月/); // 2025年9月
  if (match) {
    return { year: parseInt(match[1].slice(-2)), month: parseInt(match[2]) };
  }
  
  match = key.match(/(\d{4})-(\d+)/); // 2025-9
  if (match) {
    return { year: parseInt(match[1].slice(-2)), month: parseInt(match[2]) };
  }
  
  match = key.match(/(\d{2})月/); // 9月 (假设当前年)
  if (match) {
    return { year: currentYear, month: parseInt(match[1]) };
  }
  
  return null;
}

// 增强的loadSheet函数，添加更多调试信息
function loadSheet() {
  const sheetKey = getSheetName(currentYear, currentMonth);
  console.log(`尝试加载Sheet: ${sheetKey}`);
  
  currentSheet = sheetData[sheetKey] || [];
  console.log(`加载到 ${currentSheet.length} 行数据`);
  
  if (currentSheet.length === 0) {
    document.getElementById('content').innerHTML = '<div class="text-light text-center">当前年/月无数据。</div>';
    document.getElementById('dataSummary').textContent = '当前年/月无数据';
    
    // 显示可用的Sheet列表
    const availableSheets = Object.keys(sheetData).join(', ');
    console.log('可用的Sheet:', availableSheets);
    return;
  }

  // 添加映射渠道列
  currentSheet.forEach(row => {
    row.mapped_channel = mapChannel(row['渠道'] || '');
  });

  console.log('数据列名:', Object.keys(currentSheet[0]));
  
  // 解析每日列: e.g., "9月1日GMV"
  dailyColumns = Object.keys(currentSheet[0]).filter(c => {
    const match = c.match(`${currentMonth}月(\\d+)日GMV`);
    if (match) {
      console.log(`找到日期列: ${c}`);
    }
    return match;
  }).sort((a, b) => parseInt(a.match(/(\d+)日/)[1]) - parseInt(b.match(/(\d+)日/)[1]));

  console.log(`找到 ${dailyColumns.length} 个日期列:`, dailyColumns);

  // 默认选最后一天 (当前日期9月26日)
  const todayDay = today.getDate(); // 26
  selectedDate = dailyColumns.find(c => parseInt(c.match(/(\d+)日/)[1]) === todayDay) || dailyColumns[dailyColumns.length - 1] || '';
  console.log('选中的日期列:', selectedDate);
  
  updateDateSelect();
  updateView();
  
  // 更新数据摘要
  const totalMonth = currentSheet.reduce((sum, row) => sum + getMonthGMVNum(row), 0);
  document.getElementById('dataSummary').textContent = `已加载 ${currentSheet.length} 行数据，月GMV: ${formatWan(totalMonth)}`;
}

// 添加一个测试函数，用于检查数据
function debugData() {
  console.log('=== 数据调试信息 ===');
  console.log('当前Sheet数据:', currentSheet);
  console.log('SheetData对象:', sheetData);
  console.log('当前筛选条件:', currentFilters);
  console.log('搜索关键词:', searchTerm);
  
  if (currentSheet.length > 0) {
    console.log('第一行数据示例:', currentSheet[0]);
    console.log('所有列名:', Object.keys(currentSheet[0]));
  }
}

// 在控制台中可以调用 debugData() 来检查数据状态
function updateMonthOptions() {
  const monthSelect = document.getElementById('monthSelect');
  monthSelect.innerHTML = '';
  const startM = currentQuarter ? (parseInt(currentQuarter) - 1) * 3 + 1 : 1;
  const endM = currentQuarter ? parseInt(currentQuarter) * 3 : 12;
  for (let m = startM; m <= endM; m++) {
    const sheetKey = getSheetName(currentYear, m);
    if (sheetData[sheetKey]) {
      monthSelect.appendChild(new Option(`${m}月`, m));
    }
  }
  if (monthSelect.options.length > 0) {
    monthSelect.value = currentMonth = startM;
  }
}

function loadSheet() {
  const sheetKey = getSheetName(currentYear, currentMonth);
  currentSheet = sheetData[sheetKey] || [];
  if (currentSheet.length === 0) {
    document.getElementById('content').innerHTML = '<div class="text-light text-center">当前年/月无数据。</div>';
    document.getElementById('dataSummary').textContent = '当前年/月无数据';
    return;
  }

  // 添加映射渠道列
  currentSheet.forEach(row => {
    row.mapped_channel = mapChannel(row['渠道'] || '');
  });

  // 解析每日列: e.g., "9月1日GMV"
  dailyColumns = Object.keys(currentSheet[0]).filter(c => {
    const match = c.match(`${currentMonth}月(\\d+)日GMV`);
    return match;
  }).sort((a, b) => parseInt(a.match(/(\d+)日/)[1]) - parseInt(b.match(/(\d+)日/)[1]));

  // 默认选最后一天 (当前日期9月26日)
  const todayDay = today.getDate(); // 26
  selectedDate = dailyColumns.find(c => parseInt(c.match(/(\d+)日/)[1]) === todayDay) || dailyColumns[dailyColumns.length - 1] || '';
  updateDateSelect();
  updateView();
}

function updateDashboardIndicators(data) {
  // 年数据
  document.getElementById('year-target').textContent = formatNumber(data.yearTarget) + '万';
  document.getElementById('year-gmv').textContent = formatNumber(data.yearGMV) + '万';
  document.getElementById('year-achieve-rate').textContent = (data.yearAchieveRate || 0).toFixed(1) + '%';
  document.getElementById('year-yoy').textContent = (data.yearYOY || 0).toFixed(1) + '%';

  // 季数据
  document.getElementById('quarter-target').textContent = formatNumber(data.quarterTarget) + '万';
  document.getElementById('quarter-gmv').textContent = formatNumber(data.quarterGMV) + '万';
  document.getElementById('quarter-achieve-rate').textContent = (data.quarterAchieveRate || 0).toFixed(1) + '%';
  document.getElementById('quarter-yoy').textContent = (data.quarterYOY || 0).toFixed(1) + '%';

  // 月数据
  document.getElementById('month-target').textContent = formatNumber(data.monthTarget) + '万';
  document.getElementById('month-gmv').textContent = formatNumber(data.monthGMV) + '万';
  document.getElementById('month-achieve-rate').textContent = (data.monthAchieveRate || 0).toFixed(1) + '%';
  document.getElementById('month-yoy').textContent = (data.monthYOY || 0).toFixed(1) + '%';

  // 日数据
  document.getElementById('day-target').textContent = formatNumber(data.dayTarget) + '万';
  document.getElementById('day-gmv').textContent = formatNumber(data.dayGMV) + '万';
  document.getElementById('day-achieve-rate').textContent = (data.dayAchieveRate || 0).toFixed(1) + '%';
  document.getElementById('day-yoy').textContent = (data.dayYOY || 0).toFixed(1) + '%';
}

// 辅助函数：格式化数字（保留1位小数）
function formatNumber(num) {
  return (num || 0).toFixed(1);
}

function updateDateSelect() {
  const dateSelect = document.getElementById('dateSelect');
  dateSelect.innerHTML = '';
  dailyColumns.forEach(c => dateSelect.appendChild(new Option(c.replace('GMV', '').trim(), c)));
  if (selectedDate) dateSelect.value = selectedDate;
}

/* ============================
   日期切换
   ============================ */
function changeDate(delta) {
  const idx = dailyColumns.indexOf(selectedDate);
  const newIdx = Math.max(0, Math.min(dailyColumns.length - 1, idx + delta));
  selectedDate = dailyColumns[newIdx];
  updateDateSelect();
  updateView();
}

/* ============================
   GMV 计算 (支持跨sheet年/季，使用mapped_channel)
   ============================ */
function getTodayGMVNum(row) {
  return toNum(row[selectedDate]);
}

function getMonthGMVNum(row, uptoDay = getDayNumber(selectedDate)) {
  const endIdx = dailyColumns.findIndex(c => parseInt(c.match(/(\d+)日/)[1]) > uptoDay);
  let sum = 0;
  for (let i = 0; i < endIdx; i++) sum += toNum(row[dailyColumns[i]]);
  return sum;
}

function getMonthTargetNum(row) {
  return toNum(row[`${currentMonth}月目标`]);
}

function getYearGMVNum(row, year = currentYear) {
  let total = 0;
  for (let m = 1; m <= 12; m++) {
    const sheetKey = getSheetName(year, m);
    const monthSheet = sheetData[sheetKey];
    if (!monthSheet) continue;
    const matchRow = monthSheet.find(r =>
      r['实控人'] === row['实控人'] &&
      r['经销商主体'] === row['经销商主体'] &&
      r['mapped_channel'] === row['mapped_channel'] &&  // 使用mapped
      r['店铺'] === row['店铺']
    );
    if (matchRow) {
      const cols = Object.keys(matchRow).filter(c => c.includes(`${m}月`) && c.includes('日GMV')).sort((a, b) => parseInt(a.match(/(\d+)日/)[1]) - parseInt(b.match(/(\d+)日/)[1]));
      total += cols.reduce((s, c) => s + toNum(matchRow[c]), 0);
    }
  }
  return total;
}

function getDayNumber(col) {
  return parseInt(col.match(/(\d+)日/)[1]);
}

function aggregateRange(sheet, filters, uptoDay, monthNum) {
  let sum = 0;
  const monthCols = Object.keys(sheet[0] || {}).filter(c => {
    const match = c.match(`${monthNum}月(\\d+)日GMV`);
    return match;
  }).sort((a, b) => parseInt(a.match(/(\d+)日/)[1]) - parseInt(b.match(/(\d+)日/)[1]));
  const endIdx = monthCols.findIndex(c => parseInt(c.match(/(\d+)日/)[1]) > uptoDay);
  sheet.forEach(row => {
    if (filters.person && row['实控人'] !== filters.person) return;
    if (filters.dealer && row['经销商主体'] !== filters.dealer) return;
    if (filters.channel && row['mapped_channel'] !== filters.channel) return;  // 使用mapped
    if (filters.store && row['店铺'] !== filters.store) return;
    for (let i = 0; i < endIdx; i++) {
      sum += toNum(row[monthCols[i]]);
    }
  });
  return sum;
}

function getAggregateMoM(filters) {
  const curMonth = currentMonth;
  const selDay = getDayNumber(selectedDate);
  if (curMonth <= 1) return '-';
  let prevMonth = curMonth - 1;
  let prevYear = currentYear;
  if (prevMonth === 0) {
    prevMonth = 12;
    prevYear--;
  }
  const prevSheetKey = getSheetName(prevYear, prevMonth);
  const prevSheet = sheetData[prevSheetKey];
  if (!prevSheet) return '-';
  const curSum = aggregateRange(currentSheet, filters, selDay, curMonth);
  const prevSum = aggregateRange(prevSheet, filters, selDay, prevMonth);
  if (prevSum === 0) return curSum === 0 ? '0.0%' : 'N/A';
  const ratio = ((curSum - prevSum) / prevSum * 100).toFixed(1);
  return ratio + '%';
}

function aggregateSingleDay(sheet, filters, col) {
  let sum = 0;
  sheet.forEach(row => {
    if (filters.person && row['实控人'] !== filters.person) return;
    if (filters.dealer && row['经销商主体'] !== filters.dealer) return;
    if (filters.channel && row['mapped_channel'] !== filters.channel) return;  // 使用mapped
    if (filters.store && row['店铺'] !== filters.store) return;
    sum += toNum(row[col]);
  });
  return sum;
}

function getAggregateDayMoM(filters) {
  const curDay = getDayNumber(selectedDate);
  if (curDay <= 1) return '-';
  const prevDayCol = `${currentMonth}月${curDay - 1}日GMV`;
  const curSum = aggregateSingleDay(currentSheet, filters, selectedDate);
  const prevSum = aggregateSingleDay(currentSheet, filters, prevDayCol);
  if (prevSum === 0) return curSum === 0 ? '0.0%' : 'N/A';
  const ratio = ((curSum - prevSum) / prevSum * 100).toFixed(1);
  return ratio + '%';
}

/* ============================
   搜索过滤
   ============================ */
function filterSheet(term, sheet = currentSheet) {
  if (!term) return sheet;
  return sheet.filter(row =>
    (row['实控人'] || '').toLowerCase().includes(term) ||
    (row['经销商主体'] || '').toLowerCase().includes(term) ||
    (row['渠道'] || '').toLowerCase().includes(term) ||
    (row['mapped_channel'] || '').toLowerCase().includes(term) ||
    (row['店铺'] || '').toLowerCase().includes(term)
  );
}

/* ============================
   更新视图
   ============================ */
function updateView() {
  const filteredSheet = filterSheet(searchTerm);
  if (currentPage === 'dashboard') showDashboard(filteredSheet);
  buildChartTargetOptions(filteredSheet);
  updateQuickStats(filteredSheet);
  updateDashboardCards(filteredSheet);
}

function showDashboard(filteredSheet = currentSheet) {
  const container = document.getElementById('content');
  const yearStr = `20${currentYear}`;
  const quarterStr = currentQuarter ? `Q${currentQuarter}` : '全年';
  container.innerHTML = `
    <div class="flex mb-2">
      <a href="#" onclick="showHomePage()" class="clickable">首页</a> 
      <span class="text-light mx-1">></span>
      <span>${yearStr}年 ${quarterStr} 大盘</span>
    </div>
    <h3 class="card-title mb-2">实控人总览 (搜索: "${searchTerm || '全部'}")</h3>
    <div class="table-container">
      <table class="table">
        <thead><tr>
          <th>实控人</th><th>编码</th><th>月目标</th><th>月GMV</th><th>月环比</th><th>年GMV</th><th>当日GMV</th><th>日环比</th><th>达成率</th>
        </tr></thead>
        <tbody id="dashboardTableBody"></tbody>
      </table>
    </div>
    <div class="flex-center mt-2">
      <button onclick="showPersonOptions('')" class="btn btn-secondary">查看档案</button>
    </div>
  `;

  const summary = {};
  filteredSheet.forEach(row => {
    const p = row['实控人'] || '未命名';
    if (!summary[p]) summary[p] = { month: 0, day: 0, year: 0, target: 0 };
    summary[p].month += getMonthGMVNum(row);
    summary[p].day += getTodayGMVNum(row);
    summary[p].year += getYearGMVNum(row);
    summary[p].target += getMonthTargetNum(row);
  });

  const tbody = document.getElementById('dashboardTableBody');
  Object.keys(summary).sort().forEach(p => {  // 排序
    const s = summary[p];
    const code = personProfiles[p]?.code || '';
    const mom = getAggregateMoM({ person: p });
    const dom = getAggregateDayMoM({ person: p });
    const rate = safeDiv(s.month, s.target);
    const rowClass = parseFloat(rate.replace('%', '')) < 80 ? 'warning' : '';
    tbody.innerHTML += `
      <tr class="${rowClass}">
        <td><span class="clickable" onclick="showPersonOptions('${p.replace(/'/g, "\\'")}')">${p}</span></td>
        <td><span class="badge">${code}</span></td>
        <td>${formatWan(s.target)}</td>
        <td>${formatWan(s.month)}</td>
        <td>${mom}</td>
        <td>${formatWan(s.year)}</td>
        <td>${formatWan(s.day)}</td>
        <td>${dom}</td>
        <td>${rate}</td>
      </tr>
    `;
  });
  
  // 更新数据摘要
  const totalMonth = filteredSheet.reduce((sum, row) => sum + getMonthGMVNum(row), 0);
  const totalTarget = filteredSheet.reduce((sum, row) => sum + getMonthTargetNum(row), 0);
  document.getElementById('dataSummary').textContent = `共 ${Object.keys(summary).length} 个实控人，月GMV: ${formatWan(totalMonth)}，目标: ${formatWan(totalTarget)}`;
}

function updateDashboardCards(filteredSheet = currentSheet) {
  // 这里可以添加更详细的仪表盘数据计算
  // 目前已在showDashboard中更新数据摘要
}

function updateQuickStats(filteredSheet = currentSheet) {
  const quickStats = document.getElementById('quickStats');
  quickStats.style.display = filteredSheet.length > 0 ? 'block' : 'none';
  if (filteredSheet.length === 0) return;
  const statsList = document.getElementById('statsList');
  const storeSummary = {};
  filteredSheet.forEach(row => {
    const store = row['店铺'] || '未命名';
    if (!storeSummary[store]) storeSummary[store] = 0;
    storeSummary[store] += getMonthGMVNum(row);
  });
  const topStores = Object.entries(storeSummary).sort((a, b) => b[1] - a[1]).slice(0, 3);
  statsList.innerHTML = topStores.map(([store, gmv], i) => 
    `<li class="flex-between mb-1" style="padding: 8px; border-bottom: 1px solid var(--border-light);">
      <span>${i+1}. ${store}</span>
      <strong class="text-primary">${formatWan(gmv)}</strong>
    </li>`
  ).join('');
}

/* ============================
   下钻导航 (使用mapped_channel)
   ============================ */
function showHomePage() {
  currentPage = 'dashboard';
  currentFilters = { person: '', dealer: '', channel: '', store: '' };
  updateView();
}

function showPersonOptions(person = '') {
  currentFilters.person = person;
  currentPage = 'person';
  const container = document.getElementById('content');
  const breadcrumb = person ? 
    `<a onclick="showHomePage()" class="clickable">首页</a> <span class="text-light mx-1">></span> <span>实控人: ${person}</span>` : 
    `<a onclick="showHomePage()" class="clickable">首页</a> <span class="text-light mx-1">></span> 实控人列表`;
  container.innerHTML = `
    <div class="flex mb-2">${breadcrumb}</div>
    <h3 class="card-title mb-2">${person ? `${person} - 经销商` : '所有实控人'}</h3>
    <div class="table-container">
      <table class="table"><thead><tr><th>经销商</th><th>月目标</th><th>月GMV</th><th>月环比</th><th>年GMV</th><th>当日</th><th>日环比</th><th>达成率</th></tr></thead><tbody id="personTableBody"></tbody></table>
    </div>
    <div class="flex-center mt-2">
      ${person ? `<button onclick="showProfile('${person.replace(/'/g, "\\'")}')" class="btn btn-secondary">查看档案</button>` : ''}
      <button onclick="showHomePage()" class="btn btn-secondary ml-1">返回大盘</button>
    </div>
  `;

  const filtered = filterSheet(searchTerm);
  const dealerSummary = {};
  filtered.forEach(row => {
    if (person && row['实控人'] !== person) return;
    const d = row['经销商主体'] || '未命名';
    if (!dealerSummary[d]) dealerSummary[d] = { month: 0, day: 0, year: 0, target: 0 };
    dealerSummary[d].month += getMonthGMVNum(row);
    dealerSummary[d].day += getTodayGMVNum(row);
    dealerSummary[d].year += getYearGMVNum(row);
    dealerSummary[d].target += getMonthTargetNum(row);
  });

  const keys = Object.keys(dealerSummary).sort((a, b) => dealerOrder.indexOf(a) - dealerOrder.indexOf(b)).filter(Boolean);
  const tbody = document.getElementById('personTableBody');
  keys.forEach(d => {
    const s = dealerSummary[d];
    const mom = getAggregateMoM({ ...currentFilters, dealer: d });
    const dom = getAggregateDayMoM({ ...currentFilters, dealer: d });
    const rate = safeDiv(s.month, s.target);
    tbody.innerHTML += `
      <tr>
        <td><span class="clickable" onclick="showChannels('${currentFilters.person.replace(/'/g, "\\'")}', '${d.replace(/'/g, "\\'")}')">${d}</span></td>
        <td>${formatWan(s.target)}</td>
        <td>${formatWan(s.month)}</td>
        <td>${mom}</td>
        <td>${formatWan(s.year)}</td>
        <td>${formatWan(s.day)}</td>
        <td>${dom}</td>
        <td>${rate}</td>
      </tr>
    `;
  });
  if (keys.length === 0) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-light">无数据</td></tr>';
}

function showChannels(person, dealer) {
  currentFilters.dealer = dealer;
  currentPage = 'channel';
  const container = document.getElementById('content');
  const breadcrumb = `<a onclick="showHomePage()" class="clickable">首页</a> <span class="text-light mx-1">></span> <a onclick="showPersonOptions('${person.replace(/'/g, "\\'")}')" class="clickable">实控人</a> <span class="text-light mx-1">></span> <span>经销商: ${dealer}</span>`;
  container.innerHTML = `
    <div class="flex mb-2">${breadcrumb}</div>
    <h3 class="card-title mb-2">${person} - ${dealer} - 渠道</h3>
    <div class="table-container">
      <table class="table"><thead><tr><th>渠道</th><th>月目标</th><th>月GMV</th><th>月环比</th><th>年GMV</th><th>当日</th><th>日环比</th><th>达成率</th></tr></thead><tbody id="channelTableBody"></tbody></table>
    </div>
    <div class="flex-center mt-2">
      <button onclick="showPersonOptions('${person.replace(/'/g, "\\'")}')" class="btn btn-secondary">返回</button>
    </div>
  `;

  const filtered = filterSheet(searchTerm);
  const channelSummary = {};
  filtered.forEach(row => {
    if (row['实控人'] !== person || row['经销商主体'] !== dealer) return;
    const ch = row['mapped_channel'] || '未命名';  // 使用mapped
    if (!channelSummary[ch]) channelSummary[ch] = { month: 0, day: 0, year: 0, target: 0 };
    channelSummary[ch].month += getMonthGMVNum(row);
    channelSummary[ch].day += getTodayGMVNum(row);
    channelSummary[ch].year += getYearGMVNum(row);
    channelSummary[ch].target += getMonthTargetNum(row);
  });

  const tbody = document.getElementById('channelTableBody');
  Object.keys(channelSummary).sort().forEach(ch => {  // 排序
    const s = channelSummary[ch];
    const mom = getAggregateMoM({ ...currentFilters, channel: ch });
    const dom = getAggregateDayMoM({ ...currentFilters, channel: ch });
    const rate = safeDiv(s.month, s.target);
    tbody.innerHTML += `
      <tr>
        <td><span class="clickable" onclick="showStores('${person.replace(/'/g, "\\'")}', '${dealer.replace(/'/g, "\\'")}', '${ch.replace(/'/g, "\\'")}')">${ch}</span></td>
        <td>${formatWan(s.target)}</td>
        <td>${formatWan(s.month)}</td>
        <td>${mom}</td>
        <td>${formatWan(s.year)}</td>
        <td>${formatWan(s.day)}</td>
        <td>${dom}</td>
        <td>${rate}</td>
      </tr>
    `;
  });
  if (Object.keys(channelSummary).length === 0) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-light">无数据</td></tr>';
}

function showStores(person, dealer, channel) {
  currentFilters.channel = channel;
  currentPage = 'store';
  const container = document.getElementById('content');
  const breadcrumb = `<a onclick="showHomePage()" class="clickable">首页</a> <span class="text-light mx-1">></span> <a onclick="showPersonOptions('${person.replace(/'/g, "\\'")}')" class="clickable">实控人</a> <span class="text-light mx-1">></span> <a onclick="showChannels('${person.replace(/'/g, "\\'")}', '${dealer.replace(/'/g, "\\'")}')" class="clickable">经销商</a> <span class="text-light mx-1">></span> <span>渠道: ${channel}</span>`;
  container.innerHTML = `
    <div class="flex mb-2">${breadcrumb}</div>
    <h3 class="card-title mb-2">${person} - ${dealer} - ${channel} - 店铺</h3>
    <div class="table-container">
      <table class="table"><thead><tr><th>店铺</th><th>月目标</th><th>月GMV</th><th>月环比</th><th>年GMV</th><th>当日</th><th>日环比</th><th>达成率</th></tr></thead><tbody id="storeTableBody"></tbody></table>
    </div>
    <div class="flex-center mt-2">
      <button onclick="showChannels('${person.replace(/'/g, "\\'")}', '${dealer.replace(/'/g, "\\'")}')" class="btn btn-secondary">返回</button>
    </div>
  `;

  const filtered = filterSheet(searchTerm);
  const rows = filtered.filter(r =>
    r['实控人'] === person && r['经销商主体'] === dealer && r['mapped_channel'] === channel  // 使用mapped
  );
  const tbody = document.getElementById('storeTableBody');
  if (rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-light">无数据</td></tr>';
    return;
  }
  rows.forEach(row => {
    const store = row['店铺'] || '未命名';
    const monthNum = getMonthGMVNum(row);
    const yearNum = getYearGMVNum(row);
    const dayNum = getTodayGMVNum(row);
    const targetNum = getMonthTargetNum(row);
    const rate = safeDiv(monthNum, targetNum);
    const mom = getAggregateMoM({ ...currentFilters, store });
    const dom = getAggregateDayMoM({ ...currentFilters, store });
    tbody.innerHTML += `
      <tr>
        <td>${store}</td>
        <td>${formatWan(targetNum)}</td>
        <td>${formatWan(monthNum)}</td>
        <td>${mom}</td>
        <td>${formatWan(yearNum)}</td>
        <td>${formatWan(dayNum)}</td>
        <td>${dom}</td>
        <td>${rate}</td>
      </tr>
    `;
  });
}

/* ============================
   档案模态 (使用完整数据)
   ============================ */
function showProfile(person) {
  const modal = document.getElementById('profileModal');
  const profile = personProfiles[person];
  if (!profile) {
    alert('未找到档案');
    return;
  }

  // 生成tab
  const tabs = ['基础信息', '团队情况', '经销商主体', '供应商主体', '店铺信息'];
  document.getElementById('profileTabs').innerHTML = tabs.map((tab, i) =>
    `<button class="tab-btn ${i === 0 ? 'active' : ''}" onclick="switchTab(${i})">${tab}</button>`
  ).join('');

  // 内容
  const contents = [
    generateBasicHTML(profile),
    generateTeamHTML(profile),
    generateDealersHTML(profile),
    generateSuppliersHTML(profile),
    generateStoresHTML(profile)
  ];
  document.getElementById('modalBody').innerHTML = contents[0];
  window.currentContents = contents;
  modal.style.display = 'block';
}

function switchTab(idx) {
  document.querySelectorAll('#profileTabs button').forEach((b, i) => b.classList.toggle('active', i === idx));
  document.getElementById('modalBody').innerHTML = window.currentContents[idx];
}

function generateBasicHTML(profile) {
  let html = '<table class="table"><thead><tr><th>字段</th><th>值</th></tr></thead><tbody>';
  Object.entries(profile.basic).forEach(([key, value]) => {
    html += `<tr><td>${key}</td><td>${value}</td></tr>`;
  });
  html += '</tbody></table>';
  return html;
}

function generateTeamHTML(profile) {
  let html = `<div class="mb-2"><strong>总人数:</strong> ${profile.team['总人数']}</div>
              <div class="mb-2"><strong>总业务:</strong> ${profile.team['总业务']}</div>
              <div class="mb-2"><strong>25年总业绩:</strong> ${profile.team['25年总业绩']}</div>
              <div class="mb-2"><strong>25年实际完成:</strong> ${profile.team['25年实际完成']}</div>
              <h4 class="card-title mt-3">团队组织架构:</h4><ul>`;
  profile.team['团队组织架构'].forEach(item => {
    html += `<li class="mb-1">${item}</li>`;
  });
  html += '</ul>';
  return html;
}

function generateDealersHTML(profile) {
  const rows = profile.dealers;
  let html = '<div class="table-container"><table class="table"><thead><tr><th>序号</th><th>类型</th><th>统一信用社代码</th><th>经销商主体</th><th>授权品牌</th><th>许可方式</th><th>签约类型</th><th>品类</th><th>授权开始</th><th>授权截止</th></tr></thead><tbody>';
  rows.forEach(row => {
    html += '<tr>' + Object.values(row).map(cell => `<td>${cell}</td>`).join('') + '</tr>';
  });
  html += '</tbody></table></div>';
  return html;
}

function generateSuppliersHTML(profile) {
  const rows = profile.suppliers;
  let html = '<div class="table-container"><table class="table"><thead><tr><th>序号</th><th>类型</th><th>统一信用社代码</th><th>供应商主体</th><th>授权品牌</th><th>生产方式</th><th>保底申领金额（元）</th><th>品类</th><th>授权开始</th><th>授权截止</th><th>组货工厂</th></tr></thead><tbody>';
  rows.forEach(row => {
    html += '<tr>' + Object.values(row).map(cell => `<td>${cell}</td>`).join('') + '</tr>';
  });
  html += '</tbody></table></div>';
  return html;
}

function generateStoresHTML(profile) {
  const rows = profile.stores;
  let html = '<div class="table-container"><table class="table"><thead><tr><th>序号</th><th>类目筛选</th><th>统一信用社代码</th><th>经销商主体</th><th>授权品牌</th><th>销售渠道-大类</th><th>销售渠道-小类</th><th>店铺类型</th><th>店铺名称</th><th>品类</th><th>授权开始</th><th>授权截止</th><th>主力供应商</th><th>本次实收保证金</th><th>25年保证金性质</th><th>25年授权费</th><th>实控人第几家店铺</th></tr></thead><tbody>';
  rows.forEach(row => {
    html += '<tr>' + Object.values(row).slice(0,17).map(cell => `<td>${cell}</td>`).join('') + '</tr>';  // 调整列数
  });
  html += '</tbody></table></div>';
  return html;
}

function closeModal(event) {
  if (event) event.stopPropagation();
  document.getElementById('profileModal').style.display = 'none';
}

/* ============================
   图表 (使用mapped_channel)
   ============================ */
function buildChartTargetOptions(filteredSheet = currentSheet) {
  const dim = document.getElementById('chartDimension').value;
  const sel = document.getElementById('chartTarget');
  sel.innerHTML = '<option value="">请选择</option>';
  let unique = [];
  if (dim === 'person') {
    unique = [...new Set(filteredSheet.map(r => r['实控人']).filter(Boolean))];
  } else if (dim === 'dealer') {
    unique = [...new Set(filteredSheet.map(r => r['经销商主体']).filter(Boolean))];
  } else if (dim === 'channel') {
    unique = [...new Set(filteredSheet.map(r => r['mapped_channel']).filter(Boolean))];
  } else if (dim === 'store') {
    unique = [...new Set(filteredSheet.map(r => r['店铺']).filter(Boolean))];
  }
  if (dim === 'dealer') unique.sort((a, b) => dealerOrder.indexOf(a) - dealerOrder.indexOf(b));
  else unique.sort();
  unique.forEach(item => sel.appendChild(new Option(item, item)));
}

function toggleCompareMode() {
  compareMode = !compareMode;
  const compareBtn = document.getElementById('compareBtn');
  compareBtn.classList.toggle('hidden', !compareMode);
  compareBtn.textContent = compareMode ? '退出比较' : '比较模式';
}

function renderChartFromControls() {
  const type = document.getElementById('chartType').value;
  const dim = document.getElementById('chartDimension').value;
  const target = document.getElementById('chartTarget').value;
  if (!target) return alert('请选择对象');
  currentFilters[dim] = target;
  renderChart(type, target, dim);
}

function renderChart(type, target, dim) {
  if (currentSheet.length === 0) return alert('无数据');
  const curMonth = currentMonth;
  const uptoDay = getDayNumber(selectedDate);
  const labels = [];
  const data = [];
  for (let d = 1; d <= uptoDay; d++) {
    labels.push(`${curMonth}月${d}日`);
    const col = `${curMonth}月${d}日GMV`;
    let sum = 0;
    currentSheet.forEach(row => {
      let match = true;
      if (currentFilters.person && row['实控人'] !== currentFilters.person) match = false;
      if (currentFilters.dealer && row['经销商主体'] !== currentFilters.dealer) match = false;
      if (currentFilters.channel && row['mapped_channel'] !== currentFilters.channel) match = false;
      if (currentFilters.store && row['店铺'] !== currentFilters.store) match = false;
      if (match) sum += toNum(row[col]);
    });
    data.push(sum / 10000);
  }

  const chartArea = document.getElementById('chartArea');
  chartArea.style.display = 'block';
  document.getElementById('chartTitle').textContent = `${target} (${curMonth}月1-${uptoDay}日) GMV趋势`;
  document.getElementById('chartSubtitle').textContent = compareMode ? '比较模式: 当前 vs 上月' : '';

  const ctx = document.getElementById('gmvChart').getContext('2d');
  if (gmvChart) gmvChart.destroy();
  const config = {
    type: type,
    data: { 
      labels, 
      datasets: [{ 
        label: 'GMV (万)', 
        data, 
        borderColor: '#c3b092', 
        backgroundColor: type === 'pie' ? ['#c3b092', '#b5a17e', '#a89a8c', '#8a7a6a', '#5a4a3e'] : 'rgba(181, 161, 126, 0.2)',
        borderWidth: 2
      }] 
    },
    options: { 
      responsive: true, 
      scales: type !== 'pie' ? { y: { beginAtZero: true } } : {},
      plugins: { 
        tooltip: { 
          callbacks: { 
            label: ctx => type === 'pie' ? 
              `${ctx.label}: ${ctx.parsed.toFixed(1)}万 (${((ctx.parsed / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1)}%)` : 
              `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}万` 
          } 
        } 
      } 
    }
  };
  if (compareMode && type !== 'pie') {
    // 简化，上月数据占位
    const prevData = data.map(d => d * 0.9);
    config.data.datasets.push({ 
      label: '上月', 
      data: prevData, 
      borderColor: '#8a7a6a', 
      backgroundColor: 'rgba(138, 122, 106, 0.2)',
      borderWidth: 2
    });
  }
  gmvChart = new Chart(ctx, config);
}

/* ============================
   导出 Excel
   ============================ */
function exportData() {
  if (currentSheet.length === 0) return alert('无数据导出');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(currentSheet);
  XLSX.utils.book_append_sheet(wb, ws, `${currentYear}-${currentMonth}月`);
  XLSX.writeFile(wb, `GMV_${currentYear}-${currentMonth}.xlsx`);
}
</script>
</script>
</body>
</html>
